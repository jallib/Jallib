-- Title: test timer0 interval w/ polling
--  
-- Author: William Welch, Copyright (c) 2008-2014, all rights reserved.
-- Adapted-by: Joep Suijs
-- Compiler: >=2.4q2
-- 
-- This file is part of jallib (https://github.com/jallib/jallib)
-- Released under the BSD license (http://www.opensource.org/licenses/bsd-license.php)
--  
-- Description: test the library timer0_poll_interval
-- 
-- This file has been generated by jallib.py from:
--    * board: board_18f2520_js.jal
--    * test : test_tmr0_poll_interval.jal
--

;@jallib section chipdef
-- chip setup
include 18f2520

pragma target  clock 20_000_000
pragma target  OSC        hs
pragma target  LVP enabled                      -- allow LVP
pragma target  WDT CONTROL                      -- watchdog software controlled

WDTCON_SWDTEN = OFF                             -- disable watchdog
;@jallib section led
-- LED IO definition
alias led             is pin_c5
alias led_direction   is pin_c5_direction

led_direction = output

if (defined(led2)) then -- compile only when led2 is defined.
   led2_direction = output
end if

-- set all IO as digital
enable_digital_io()

-- setup the timer0_poll_interval library
const timer0_overflow_rate = 1000  -- 1 kHz overflow rate
const DELAY_SLOTS = 2         -- support 2 delays at the same time
include timer0_poll_interval
timer0_poll_init()             -- init timer0

var word prev_interval_counter

forever loop   
   
   if (timer0_interval_counter != prev_interval_counter) then
      prev_interval_counter = timer0_interval_counter
      -- put here code that you want  
      -- to execute each tick.               
   end if ; 1 kHz loop   
   
   if (check_delay(0)) then
      set_delay(0, 409) -- 409 ticks on delay-slot 0
      led = !led                  
   end if
      if (defined(led2)) then -- compile only when led2 is defined.
   if (check_delay(1)) then
      set_delay(1, 619) -- 619 ticks on delay-slot 1
        led2 = !led2
      end if
   end if
end loop

; end of main