-- ----------------------------------------------------------------------------
-- Title: shift_register_74595
--
-- Author: Joep Suijs, Copyright (C) 2014 .. 2014 Joep Suijs
--
-- Adapted-by: 
--
-- Compiler: >=2.4q2
--
-- This file is part of jallib (https://github.com/jallib/jallib)
-- Released under the ZLIB license (http://www.opensource.org/licenses/zlib-license.html)
--
-- Description: Control of 74595 shift register
-- .
-- Setup:
-- alias sr_scl   is pin_d2   ; SRCK  (serial clock, rising egde)
-- alias sr_g     is pin_d3   ; G (output enable, low = enable)
-- alias sr_sda   is pin_d1   ; SER_IN   / DS
-- alias sr_rck   is pin_d3   ; RCK (parallel clock / load, rising edge)
-- --                                                
-- include shift_register_74595
-- sr_output_enable(1)  ; activate shift register outputs --
-- --
-- Use:
-- --
-- -- set one output of each shift register      
-- sr_write(data)   ; data for 74595 - end of chain
-- -- sw_write for all intermediate 74595 here
-- sr_write(data)   ; data for 74595 #1 (directly connected to PIC) 
-- sr_commit()   ; clock all data to outputs
--
-- This file has been generated by hand (manually maintained)
--
-- TODO:
--
-- --------------------------------------------------------------------



-- ----------------------------------------------------------------------------
-- sr_write - write one byte of data to chip
-- ----------------------------------------------------------------------------
-- ----------------------------------------------------------------------------
procedure sr_write(byte in data) is
   var bit out_bit at data:7
      
   for 8 loop
      sr_sda = out_bit
      sr_scl = false ; prepare
      data = data * 2
      sr_scl = true  ; rising edge = clock
   end loop
   
   sr_rck = false   ; prepare commit
     
end procedure

-- ----------------------------------------------------------------------------
--  sr_enable - enable / disable parallel outputs of shift register
-- ----------------------------------------------------------------------------
-- ----------------------------------------------------------------------------
procedure sr_output_enable(bit in enable) is
   sr_g = !enable
end procedure

-- ----------------------------------------------------------------------------
--  sr_commit - commit (activate) previous provided data
-- ----------------------------------------------------------------------------
--  Note: the RCK pin is set to low in the write() procedure,
--        as a preperation for the commit.
-- ----------------------------------------------------------------------------
procedure sr_commit() is
   sr_rck = true    ; rising edge = activate   
end procedure

